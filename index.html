<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1.0,shrink-to-fit=no"
    />
    <meta name="robots" content="all" />
    <meta name="author" content="webdicebot@gmail.com" />
    <title>Dice Simulator - product of Web DiceBot</title>
    <link rel="icon" href="/favicon.ico" />
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Courier New", monospace;
        background: #fff3e0;
      }

      .bg-header {
        background: #f57c00;
      }

      .text-brand {
        color: #f57c00;
        font-weight: bold;
      }

      .config-card {
        max-width: 500px;
        margin: 0 auto;
      }
    </style>
  </head>

  <body>
    <div class="container py-4 pt-5">
      <div class="text-center mb-4">
        <h1 class="display-5">
          Welcome to
          <span class="text-brand">Dice Simulator</span>
        </h1>
        <p class="lead mx-auto" style="max-width: 600px">
          A tool for testing your script. It only supports the script testing
          process and does not reflect actual profits when applied to real dice
          sites
        </p>
      </div>

      <div class="card config-card shadow">
        <div class="card-header bg-header text-white">
          <h3 class="card-title mb-0">Configuration</h3>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="balance" class="form-label">Balance</label>
              <input
                class="form-control form-number"
                type="number"
                id="balance"
                value="100"
              />
            </div>

            <div class="col-md-6">
              <label for="decimal" class="form-label">Decimal</label>
              <input
                class="form-control form-number"
                type="number"
                id="decimal"
                value="8"
              />
            </div>

            <div class="col-md-6">
              <label for="delay" class="form-label">Delay per bet</label>
              <div class="input-group">
                <input
                  class="form-control form-number"
                  type="number"
                  id="delay"
                  value="0"
                />
                <span class="input-group-text">second(s)</span>
              </div>
            </div>

            <div class="col-md-6">
              <label for="houseEdge" class="form-label">House Edge</label>
              <div class="input-group">
                <input
                  class="form-control form-number"
                  type="number"
                  id="houseEdge"
                  value="1"
                  min="0"
                  max="100"
                  step="0.01"
                />
                <span class="input-group-text">%</span>
              </div>
            </div>

            <div class="col-12">
              <label for="clientSeed" class="form-label">Client Seed</label>
              <div class="input-group">
                <input type="text" class="form-control" id="clientSeed" />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  data-bs-action="randomClientSeed"
                >
                  Random
                </button>
              </div>
            </div>

            <div class="col-12">
              <label for="serverSeed" class="form-label">Server Seed</label>
              <div class="input-group">
                <input type="text" class="form-control" id="serverSeed" />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  data-bs-action="randomServerSeed"
                >
                  Random
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap 5 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let simulator = {
        balance: 100,
        decimal: 8,
        delay: 0,
        clientSeed: randomSeed(16),
        serverSeed: randomSeed(64),
        nonce: 0,
        houseEdge: 1,
        randomClientSeed: function () {
          this.clientSeed = randomSeed(16);
          document.getElementById("clientSeed").value = this.clientSeed;
        },
        randomServerSeed: function () {
          this.serverSeed = randomSeed(64);
          document.getElementById("serverSeed").value = this.serverSeed;
        },
        roll: async function (amount, target, side) {
          // console.log(amount, target, side)
          if (amount < 0) return { msg: "Amount must be greater than 0" };
          if (target <= 0 || target > 9999)
            return { msg: "Target number must be between 1 and 9999" };
          if (this.balance <= 0 || this.balance < amount)
            return { msg: "Balance is not enough" };
          const sides = ["over", "under"];
          if (!sides.includes(side))
            return { msg: "Side must be over or under" };

          this.nonce += 1;

          let win = false;
          let profit = 0;
          const resultNumber = await roll(
            this.serverSeed,
            this.clientSeed,
            this.nonce
          );
          // console.log("target", target);
          // console.log("resultNumber", resultNumber);

          let multiplier;
          const houseEdgeMultiplier = 1 - this.houseEdge / 100;
          if (side === "over") {
            resultNumber > target ? (win = true) : (win = false);
            multiplier = (9999 / (9999 - target)) * houseEdgeMultiplier;
          } else {
            resultNumber < target ? (win = true) : (win = false);
            multiplier = (9999 / target) * houseEdgeMultiplier;
          }

          // console.log("multiplier", multiplier);

          if (win) {
            profit = amount * multiplier - amount;
          } else {
            profit = 0 - amount;
          }

          this.balance += profit;
          document.getElementById("balance").value = this.balance;

          return { profit, resultNumber, nonce: this.nonce };
        },
      };

      // Bootstrap-style event handling using event delegation
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize form values
        document.getElementById("clientSeed").value = simulator.clientSeed;
        document.getElementById("serverSeed").value = simulator.serverSeed;
        document.getElementById("houseEdge").value = simulator.houseEdge;

        // Event delegation for button clicks
        document.addEventListener("click", function (event) {
          const action = event.target.getAttribute("data-bs-action");
          if (action && simulator[action]) {
            simulator[action]();
          }
        });

        // Event delegation for input changes
        document.addEventListener("input", function (event) {
          const target = event.target;
          const id = target.id;

          switch (id) {
            case "balance":
              simulator.balance = Number(target.value);
              break;
            case "decimal":
              simulator.decimal = Number(target.value);
              break;
            case "delay":
              simulator.delay = Number(target.value);
              break;
            case "houseEdge":
              simulator.houseEdge = Number(target.value);
              break;
          }
        });
      });

      async function roll(serverSeed, clientSeed, nonce) {
        const nonceClientSeed = `${clientSeed}-${nonce}`;

        const encoder = new TextEncoder();
        const key = await crypto.subtle.importKey(
          "raw",
          encoder.encode(serverSeed),
          { name: "HMAC", hash: { name: "SHA-512" } },
          false,
          ["sign"]
        );

        const signature = await crypto.subtle.sign(
          "HMAC",
          key,
          encoder.encode(nonceClientSeed)
        );
        const hashArray = Array.from(new Uint8Array(signature));
        const hex = hashArray
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");

        let index = 0;
        let lucky = parseInt(hex.substring(index * 5, index * 5 + 5), 16);

        while (lucky >= 1e6) {
          index += 1;
          lucky = parseInt(hex.substring(index * 5, index * 5 + 5), 16);
          if (index * 5 + 5 > 128) {
            lucky = 9999;
            break;
          }
        }

        return lucky % 10000;
      }

      function randomSeed(length) {
        let result = "";
        const characters = "abcdef0123456789";
        const charactersLength = characters.length;
        let counter = 0;
        while (counter < length) {
          result += characters.charAt(
            Math.floor(Math.random() * charactersLength)
          );
          counter += 1;
        }
        return result;
      }
    </script>
  </body>
</html>
